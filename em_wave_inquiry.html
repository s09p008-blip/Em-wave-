<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>電磁波 探究シミュレーション（高校3年・40分アクティビティ）</title>
<style>
  /* ---------------- 共通スタイル（外部ライブラリ不使用） ---------------- */
  :root{
    --bg:#ffffff; --fg:#0f1216; --panel:#f5f6f8; --grid:#e7e9ee;
    --muted:#7a8596; --accent:#2a7de1;
    --E:#e53935; --B:#1e88e5; --S:#00bfa5;
  }
  body.dark{
    --bg:#0f1115; --fg:#eef2f7; --panel:#141923; --grid:#262c36;
    --muted:#b9c0cc; --accent:#64b5f6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);
       font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;}
  header{min-width:1024px; display:flex;gap:12px;align-items:center;flex-wrap:wrap;
         padding:12px 14px;border-bottom:1px solid var(--grid)}
  h1{font-size:18px;margin:0 10px 0 0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--grid);background:var(--panel);color:var(--fg);
       padding:6px 10px;border-radius:12px;cursor:pointer}
  .btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .select,.range,.number{
    padding:6px 10px;border:1px solid var(--grid);
    background:var(--panel);color:var(--fg);border-radius:10px
  }
  main{min-width:1024px;display:grid;grid-template-columns:1fr 360px;gap:12px;padding:12px}
  canvas{width:100%;height:540px;border:1px solid var(--grid);border-radius:14px;background:var(--bg)}
  .small{height:220px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:10px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
  .legend span{display:inline-flex;align-items:center;gap:6px;margin-right:12px;font-size:12px}
  .chip{background:var(--accent);color:#fff;border-radius:999px;padding:2px 8px;font-size:11px}
  .dot{width:14px;height:4px;border-radius:2px;display:inline-block}
  .circle{width:11px;height:11px;border-radius:50%;border:2px solid var(--B);display:inline-block}
  ul{margin:0 0 0 18px;padding:0}
  .meter{height:10px;background:linear-gradient(90deg,#6ee7b7,#22c55e,#16a34a);border-radius:999px}
  .meter>div{height:100%;width:0;border-radius:999px;background:inherit}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>電磁波 探究シミュレーション</h1>
  <div class="toolbar">
    <!-- 教科書項目に対応する2場面：①電気振動と放射（発生） ②伝搬と利用（受信） -->
    <button class="btn active" data-mode="emission">A: 電気振動と放射（LC→ダイポール）</button>
    <button class="btn" data-mode="propagation">B: 伝搬・情報とエネルギー（受信）</button>
    <select id="bgSel" class="select">
      <option value="light">白背景</option>
      <option value="dark">黒背景</option>
    </select>
    <span class="chip" id="fps">- fps</span>
  </div>
</header>

<main>
  <!-- 左：主キャンバス＋補助グラフ -->
  <div>
    <canvas id="main"></canvas>

    <div class="card" style="margin-top:10px">
      <div class="row">
        <div style="flex:1">
          <label>送信側の電気振動（I(t), Q(t)）/ 受信信号など</label>
          <canvas id="g1" class="small"></canvas>
        </div>
        <div style="flex:1">
          <label>エネルギーの移動（Uc, Ul, ポインティング S など）</label>
          <canvas id="g2" class="small"></canvas>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div class="legend">
          <span><i class="dot" style="background:var(--E)"></i>E / Q</span>
          <span><i class="dot" style="background:var(--B)"></i>B / I</span>
          <span><i class="dot" style="background:var(--S)"></i>S / エネルギー</span>
        </div>
        <div class="hint" id="caption" style="margin-left:auto">Aモード：LCの電気振動→アンテナから波面が広がる。</div>
      </div>
    </div>
  </div>

  <!-- 右：コントロール＆Peer Instruction（予測→実験→議論） -->
  <div class="card">
    <!-- 予測 -->
    <div>
      <div class="row" style="justify-content:space-between">
        <b>Peer Instruction：① 予測</b>
        <button id="reset" class="btn">初期化</button>
      </div>
      <label>問いP1：周波数 f を2倍にすると，波長 λ はどうなる？</label>
      <div class="row">
        <label><input type="radio" name="p1"> 2倍になる</label>
        <label><input type="radio" name="p1"> そのまま</label>
        <label><input type="radio" name="p1"> 1/2になる（正解）</label>
      </div>
      <label>問いP2：振幅 A を2倍にすると，受信強度はどう変わる？</label>
      <div class="row">
        <label><input type="radio" name="p2"> ほぼ2倍</label>
        <label><input type="radio" name="p2"> ほぼ4倍（正解に近い：I∝A²）</label>
        <label><input type="radio" name="p2"> 変わらない</label>
      </div>
    </div>

    <!-- 実験：スライダー群（必要最小限。各モードで共通2+追加1） -->
    <div style="margin-top:12px">
      <b>② 実験（パラメータ）</b>
      <label>振幅 A</label>
      <input id="amp" class="range" type="range" min="0.3" max="2.5" step="0.1" value="1.0">
      <label>周波数 f（相対）</label>
      <input id="freq" class="range" type="range" min="0.4" max="3.0" step="0.1" value="1.0">

      <div id="extraEmission">
        <label>LCパラメータ（概念）：L, C（f≈1/2π√LC）</label>
        <div class="row">
          <input id="Lval" class="range" type="range" min="0.4" max="2.0" step="0.1" value="1.0" style="flex:1">
          <input id="Cval" class="range" type="range" min="0.4" max="2.0" step="0.1" value="1.0" style="flex:1">
        </div>
        <div class="hint">共振周波数：<b id="fLC">-</b>（相対）</div>
      </div>

      <div id="extraPropagation" style="display:none">
        <label>送受信距離（相対）</label>
        <input id="dist" class="range" type="range" min="0.3" max="1.2" step="0.05" value="0.8">
        <label>媒質の屈折率 n（進行方向の波面間隔に影響：λ∝1/n）</label>
        <input id="nmed" class="range" type="range" min="1.00" max="1.80" step="0.01" value="1.00">
      </div>

      <div class="row" style="margin-top:8px">
        <button id="run" class="btn">▶ 実験開始 / 一時停止</button>
        <button id="mark" class="btn">データ点をマーク</button>
      </div>
    </div>

    <!-- 観測（利用） -->
    <div style="margin-top:12px">
      <b>③ 観測（受信メータ）</b>
      <div class="meter"><div id="meterFill"></div></div>
      <div class="hint">受信強度はおおむね <code>~ A² / r²</code>（相対）。波長は <code>λ ≈ c/f</code>（ここでは c=一定）。</div>
    </div>

    <!-- 議論：まとめプロンプト -->
    <div style="margin-top:12px">
      <b>④ 議論の視点</b>
      <ul>
        <li>f↑でλ↓になったか？（c一定の説明ができるか）</li>
        <li>A↑で受信強度はどう比例したか？（情報・エネルギーの運び）</li>
        <li>アンテナ周囲の波面の見え方と，S（エネルギーの向き）の整合は？</li>
      </ul>
    </div>
  </div>
</main>

<script>
/* ============================================================
   電磁波 探究シミュレーション（高校3年・40分）
   目的：
    - 電気振動 → 放射 → 伝搬 → 利用（情報/エネルギー）の連続性を
      1画面で直感的に観察・操作できるようにする
   学習目標対応：
    - 電気振動（LC）可視化：I(t), Q(t), Uc, Ul
    - 発生（アンテナからの波面）・伝搬（c一定、λ∝1/f）・S（エネルギー流）
    - 利用（受信強度・距離・振幅依存）
   Peer Instruction：
    - 予測（右上の選択肢）→ 実験（スライダー/再生）→ 議論（視点提示）
   実装方針：
    - 外部ライブラリなし、単一HTML、コメント日本語
    - 1024px以上で快適
============================================================ */

const main = document.getElementById('main');
const g1   = document.getElementById('g1');
const g2   = document.getElementById('g2');
const ctx  = main.getContext('2d');
const c1   = g1.getContext('2d');
const c2   = g2.getContext('2d');

const modeBtns = [...document.querySelectorAll('.btn[data-mode]')];
const bgSel = document.getElementById('bgSel');
const fpsChip = document.getElementById('fps');

const amp = document.getElementById('amp');
const freq = document.getElementById('freq');
const Lval = document.getElementById('Lval');
const Cval = document.getElementById('Cval');
const fLC = document.getElementById('fLC');
const dist = document.getElementById('dist');
const nmed = document.getElementById('nmed');

const extraEmission = document.getElementById('extraEmission');
const extraPropagation = document.getElementById('extraPropagation');

const caption = document.getElementById('caption');
const meterFill = document.getElementById('meterFill');

const resetBtn = document.getElementById('reset');
const runBtn = document.getElementById('run');
const markBtn = document.getElementById('mark');

/* --------- レイアウト（Retina対応） --------- */
function fit(cv){
  const r = devicePixelRatio || 1;
  const rect = cv.getBoundingClientRect();
  cv.width = Math.max(1, Math.floor(rect.width*r));
  cv.height = Math.max(1, Math.floor(rect.height*r));
  const c = cv.getContext('2d');
  c.setTransform(r,0,0,r,0,0);
}
function fitAll(){ [main,g1,g2].forEach(fit); }
window.addEventListener('resize', fitAll); fitAll();

/* --------- 背景色（白/黒） --------- */
bgSel.addEventListener('change', ()=>{
  document.body.classList.toggle('dark', bgSel.value==='dark');
});
document.body.classList.toggle('dark', bgSel.value==='dark');

/* --------- モード切替（A/B） --------- */
let mode = 'emission';
modeBtns.forEach(b=>{
  b.onclick=()=>{
    modeBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    mode = b.dataset.mode;
    extraEmission.style.display = (mode==='emission')?'block':'none';
    extraPropagation.style.display = (mode==='propagation')?'block':'none';
    caption.textContent = (mode==='emission')
      ? 'A：LCの電気振動→アンテナから波面が広がる。E/Bは同位相で直交し，Sは右向き（伝搬方向）。'
      : 'B：波の伝搬と受信。cは一定→fを上げるとλは短くなる。受信強度はおおむね A²/r²。';
  };
});

/* --------- 実験制御 --------- */
let running = true;
runBtn.onclick = ()=> running = !running;
resetBtn.onclick = ()=>{
  amp.value = 1.0; freq.value = 1.0; Lval.value=1.0; Cval.value=1.0;
  dist.value = 0.8; nmed.value=1.00; marks = [];
};
let marks = [];
markBtn.onclick = ()=>{
  // 現在の代表値をグラフ1にマーク（簡易）
  const A = Number(amp.value), F = effectiveFreq();
  marks.push({A,F, time:performance.now()/1000});
  if(marks.length>40) marks.shift();
};

/* --------- 物理モデル（相対・教育用の簡略化） --------- */
function effectiveFreq(){
  // Aモード：f ≈ (1/2π√LC)×freq,  Bモード：freq そのまま
  if(mode==='emission'){
    const L = Number(Lval.value), C = Number(Cval.value);
    const f0 = 1/(2*Math.PI*Math.sqrt(L*C));
    fLC.textContent = f0.toFixed(3);
    return f0*Number(freq.value);
  }
  return Number(freq.value);
}

/* --------- ユーティリティ描画 --------- */
function clear(cv){
  const c = cv.getContext('2d');
  c.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg');
  c.fillRect(0,0,cv.width,cv.height);
}
function grid(cv){
  const c = cv.getContext('2d');
  const w = cv.clientWidth, h = cv.clientHeight;
  c.strokeStyle = getComputedStyle(document.body).getPropertyValue('--grid');
  c.lineWidth = 1;
  c.beginPath();
  const step = 40;
  for(let x=0;x<w;x+=step){ c.moveTo(x,0); c.lineTo(x,h); }
  for(let y=0;y<h;y+=step){ c.moveTo(0,y); c.lineTo(w,y); }
  c.stroke();
}
function line(c,x1,y1,x2,y2,col,lw=2){ c.save(); c.strokeStyle=col; c.lineWidth=lw; c.beginPath(); c.moveTo(x1,y1); c.lineTo(x2,y2); c.stroke(); c.restore();}
function arrow(c,x1,y1,x2,y2,col,lw=2){ line(c,x1,y1,x2,y2,col,lw); const a=Math.atan2(y2-y1,x2-x1),L=8; c.save(); c.translate(x2,y2); c.rotate(a); c.fillStyle=col; c.beginPath(); c.moveTo(0,0); c.lineTo(-L, L*0.7); c.lineTo(-L,-L*0.7); c.closePath(); c.fill(); c.restore();}
function circle(c,x,y,r,col,lw=2){ c.save(); c.strokeStyle=col; c.lineWidth=lw; c.beginPath(); c.arc(x,y,r,0,Math.PI*2); c.stroke(); c.restore();}

/* --------- バッファ（グラフ用） --------- */
const bufE=[], bufB=[], bufU=[], bufS=[];
function pushBuf(arr,v,max=420){arr.push(v); if(arr.length>max) arr.shift();}
function plot(cv, arrs, colors, labels){
  clear(cv); grid(cv);
  const c = cv.getContext('2d'), w=cv.clientWidth, h=cv.clientHeight;
  // 軸（0, ±1を簡易）
  c.strokeStyle=getComputedStyle(document.body).getPropertyValue('--muted');
  c.beginPath(); c.moveTo(30,h-20); c.lineTo(w-10,h-20); c.moveTo(30,10); c.lineTo(30,h-20); c.stroke();
  // シリーズ描画
  arrs.forEach((arr,idx)=>{
    c.strokeStyle=colors[idx]; c.lineWidth=2; c.beginPath();
    for(let i=0;i<arr.length;i++){
      const x = 30 + (w-40)*i/Math.max(1,arr.length-1);
      const y = (h-20) - (h-30)*((arr[i]+1)/2);
      if(i===0) c.moveTo(x,y); else c.lineTo(x,y);
    }
    c.stroke();
    c.fillStyle=colors[idx]; c.fillText(labels[idx], 40, 16+14*idx);
  });
}

/* --------- メイン描画 --------- */
let last=performance.now(), acc=0, frames=0;

function loop(t){
  const dt = Math.min(0.033,(t-last)/1000); last=t;
  acc+=dt; frames++; if(acc>0.5){ fpsChip.textContent = Math.round(frames/acc)+' fps'; acc=0; frames=0; }

  if(running) state.time += dt;
  drawMain();
  drawGraphs();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* --------- 状態 --------- */
const state = { time:0 };

/* --------- A：電気振動と放射（発生） --------- */
function drawEmission(){
  clear(main); grid(main);
  const w=main.clientWidth, h=main.clientHeight;
  const A = Number(amp.value), f = effectiveFreq();
  const omega = 2*Math.PI*f;

  // LC 回路（左側）：I(t)=A sinωt, Q(t)=A cosωt（相対）
  const I = A*Math.sin(omega*state.time);
  const Q = A*Math.cos(omega*state.time);
  const Uc = 0.5*Q*Q;  // 電場エネルギー（相対）
  const Ul = 0.5*I*I;  // 磁場エネルギー（相対）

  // 概念図：コイルとコンデンサー
  const cx=120, cy=h*0.33;
  // コイル
  const c=ctx;
  c.strokeStyle = getComputedStyle(document.body).getPropertyValue('--B'); c.lineWidth=2;
  c.beginPath(); let x=40, y=cy-10; for(let i=0;i<6;i++){ c.arc(x+12,y,12,Math.PI*0.6, -Math.PI*0.6, true); x+=20; } c.stroke();
  // コンデンサー板
  line(c,x,cy-22,x,cy+22,getComputedStyle(document.body).getPropertyValue('--E'),3);
  line(c,x+18,cy-22,x+18,cy+22,getComputedStyle(document.body).getPropertyValue('--E'),3);
  // 電荷量（色）で可視化
  c.globalAlpha = Math.min(1,Math.abs(Q));
  c.fillStyle = Q>0? '#ef5350':'#64b5f6'; c.fillRect(x-4, cy-20, 8, 40);
  c.fillStyle = Q>0? '#64b5f6':'#ef5350'; c.fillRect(x+14, cy-20, 8, 40);
  c.globalAlpha = 1;
  c.fillStyle = getComputedStyle(document.body).getPropertyValue('--fg');
  c.fillText('LCの電気振動：I(t), Q(t)', 40, 24);

  // 右：ダイポールと放射（等位相リング）
  const ax=w*0.68, ay=h*0.55, aLen=90;
  line(c,ax,ay-aLen,ax,ay+aLen,'#9e9e9e',4); // アンテナ
  // 電流方向
  const dir = Math.sign(I)||1;
  arrow(c, ax, ay, ax, ay-dir*40, getComputedStyle(document.body).getPropertyValue('--S'),4);
  // 等位相リング（外向きに流れる波面 → エネルギーが運ばれる）
  for(let k=1;k<=9;k++){
    const r = (k*22 + (state.time*140)%22);
    c.globalAlpha = Math.max(0,1-r/(w*0.48));
    circle(c, ax, ay, r, getComputedStyle(document.body).getPropertyValue('--B'),1);
  }
  c.globalAlpha = 1;

  // 受信メータ（右下に仮想受信機）
  const rx = w*0.88, ry = h*0.78;
  const R  = Math.hypot(rx-ax, ry-ay);
  const intensity = Math.min(1, (A*A)/(Math.max(1,R*0.03)**2)); // ~A^2/r^2
  meterFill.style.width = (intensity*100).toFixed(1)+'%';

  // 注記
  c.fillText('アンテナから波面が広がる（Sは右向き：エネルギー流）', w*0.40, 24);

  // グラフ用にバッファ更新
  pushBuf(bufE, Math.max(-1,Math.min(1,Q)));  // E∝Q とみなす
  pushBuf(bufB, Math.max(-1,Math.min(1,I)));  // B∝I
  // 合計エネルギー（保存のイメージ）
  pushBuf(bufU, Math.max(-1,Math.min(1,(Uc+Ul)))) ;
  // S（受信位置での相対強度）
  pushBuf(bufS, Math.max(-1,Math.min(1,intensity*2-1)));
}

/* --------- B：伝搬・利用（受信） --------- */
function drawPropagation(){
  clear(main); grid(main);
  const w=main.clientWidth, h=main.clientHeight;
  const A = Number(amp.value), f = effectiveFreq();
  const omega = 2*Math.PI*f;
  const c = ctx;

  // 送信アンテナ（左）、受信アンテナ（右）。距離はスライダー dist で可変
  const left = w*0.18, right = w*(0.18 + Number(dist.value));
  const midY = h*0.55;

  // アンテナ本体
  line(c,left, midY-90, left, midY+90, '#9e9e9e',4);
  line(c,right,midY-90, right,midY+90, '#9e9e9e',4);

  // 伝搬する正弦波（位相速度 c は一定。fを上げると波長が短くなる）
  const n = Number(nmed.value);           // 媒質の屈折率
  const c_rel = 240/n;                    // 相対の見かけ速度
  const k = 2*Math.PI / Math.max(60, c_rel/f); // λ = c/f → k = 2π/λ
  // E波形（赤）
  c.strokeStyle = getComputedStyle(document.body).getPropertyValue('--E'); c.lineWidth=2; c.beginPath();
  for(let x=left;x<right;x+=3){
    const y = midY - A*45*Math.sin(k*(x-left) - omega*state.time);
    if(x===left) c.moveTo(x,y); else c.lineTo(x,y);
  } c.stroke();
  // B位相（青リング）
  for(let i=0;i<12;i++){
    const x = left + i*(right-left)/11;
    const val = Math.abs(Math.sin(k*(x-left) - omega*state.time));
    circle(c, x, midY, 5+10*val, getComputedStyle(document.body).getPropertyValue('--B'), 2);
  }
  // S（緑矢印）
  for(let i=0;i<8;i++){
    const x = left + i*(right-left)/7;
    arrow(c, x-16, midY+110, x+16, midY+110, getComputedStyle(document.body).getPropertyValue('--S'),2);
  }

  // 受信強度（~A^2/r^2）と波長ラベル
  const R = right-left;
  const intensity = Math.min(1, (A*A)/(Math.max(1,R*0.03)**2));
  meterFill.style.width = (intensity*100).toFixed(1)+'%';

  c.fillStyle = getComputedStyle(document.body).getPropertyValue('--fg');
  const lambda = (c_rel/f).toFixed(1);
  c.fillText(`λ ≈ c/f → ここでは λ ≈ ${lambda}（相対）, c一定, n=${n.toFixed(2)}`, left, midY-120);

  // グラフ用バッファ更新：観測点（受信アンテナ位置）の E(t) と S(t)
  const Eprobe = A*Math.sin(k*(right-left) - omega*state.time);
  pushBuf(bufE, Math.max(-1,Math.min(1,Eprobe)));
  pushBuf(bufB, 0.0); // Bは省略（別グラフでS/強度を重視）
  pushBuf(bufS, Math.max(-1,Math.min(1,intensity*2-1)));
  pushBuf(bufU, Math.max(-1,Math.min(1, (intensity)))); // エネルギー的な指標
}

/* --------- ディスパッチ --------- */
function drawMain(){
  if(mode==='emission') drawEmission();
  else drawPropagation();
}

/* --------- グラフ描画 --------- */
function drawGraphs(){
  // g1：時間波形（E=Q と I） or 受信 E(t)
  // g2：エネルギー（Uc,Ul, S）
  if(mode==='emission'){
    plot(g1, [bufE, bufB], [getComputedStyle(document.body).getPropertyValue('--E'), getComputedStyle(document.body).getPropertyValue('--B')], ['Q(t) ~ E', 'I(t) ~ B']);
    plot(g2, [bufU, bufS], [getComputedStyle(document.body).getPropertyValue('--S'), '#7c3aed'], ['Uc+Ul（保存イメージ）', '受信S（相対）']);
  }else{
    plot(g1, [bufE], [getComputedStyle(document.body).getPropertyValue('--E')], ['受信 E(t)（観測点）']);
    plot(g2, [bufS], [getComputedStyle(document.body).getPropertyValue('--S')], ['S（受信強度の指標）']);
  }
}

/* --------- 入力で即時反映（再描画はループ任せ） --------- */
[amp,freq,Lval,Cval,dist,nmed].forEach(el=>el.addEventListener('input',()=>{}));
</script>
</body>
</html>
